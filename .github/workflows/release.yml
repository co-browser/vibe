name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for changelog
          token: ${{ secrets.RELEASE_PAT || github.token }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.12.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Electron app for macOS
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWOR }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          NODE_ENV: production
          GH_TOKEN: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "Building Electron app for macOS..."
          pnpm --filter vibe build:mac

      - name: List build artifacts
        run: |
          echo "Build artifacts:"
          ls -la apps/electron-app/dist/

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            STATUS="Success"
            COLOR="3066993"
          else
            STATUS="Failed"
            COLOR="15158332"
          fi

          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -X POST "$DISCORD_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d "{
                \"embeds\": [{
                  \"title\": \"Vibe Release ${{ github.ref_name }}\",
                  \"description\": \"Release build status: $STATUS\",
                  \"color\": $COLOR,
                  \"fields\": [
                    {
                      \"name\": \"Version\",
                      \"value\": \"${{ github.ref_name }}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"Platform\",
                      \"value\": \"macOS\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"Workflow\",
                      \"value\": \"[View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
                      \"inline\": false
                    }
                  ],
                  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
                }]
              }"
          fi
