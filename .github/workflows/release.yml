name: Release

on:
  push:
    tags:
      - 'v*'

env:
  VIBE_VERSION: ${{ github.ref_name }}

jobs:
  # Use electron-builder's built-in publishing for proper autoupdate integration
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    strategy:
      matrix:
        platform: [mac, win, linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.12.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Lint and typecheck
        run: |
          pnpm lint
          pnpm typecheck
          pnpm format:check

      - name: Build and publish for ${{ matrix.platform }}
        run: |
          cd apps/electron-app
          pnpm build:${{ matrix.platform }} && electron-builder --${{ matrix.platform }} --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASS: ${{ secrets.APPLE_ID_PASS }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          VIBE_VERSION: ${{ github.ref_name }}

  # Fallback job for manual release creation (if needed)
  manual-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    needs: publish
    if: always() && needs.publish.result == 'failure'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.12.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Build for all platforms
        run: |
          cd apps/electron-app
          pnpm build:mac &
          pnpm build:win &
          pnpm build:linux &
          wait
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASS: ${{ secrets.APPLE_ID_PASS }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            apps/electron-app/dist/*.dmg
            apps/electron-app/dist/*.zip
            apps/electron-app/dist/*.exe
            apps/electron-app/dist/*.AppImage
            apps/electron-app/dist/*.snap
            apps/electron-app/dist/*.deb
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }} 